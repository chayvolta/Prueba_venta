<script>
  (function () {
    'use strict';

    var COLORS = {
      fonaturGreen: '#006b4f',
      fonaturTeal: '#00a58b',
      fonaturSand: '#f3e4c4',
      fonaturGold: '#f6b819',
      grey: '#9ca3af'
    };

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return text
        .toString()
        .replace(/[&<>"']/g, function (ch) {
          return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          }[ch];
        });
    }

    function parseSurface(str) {
      if (!str) return NaN;
      var clean = str.toString().replace(/\s/g, '').replace(/,/g, '');
      clean = clean.replace(/[^0-9.]/g, '');
      if (!clean) return NaN;
      var v = parseFloat(clean);
      return isNaN(v) ? NaN : v;
    }

    var map;
    var baseLayer;
    var baseLayers = {};
    var lotLayer = null;
    var geojsonData = null;
    var lotItems = [];
    var currentFilter = 'all';
    var currentDesarrollo = 'all';
    var currentSeccion = 'all';
    var currentBaseKey = 'claro';

    document.addEventListener('DOMContentLoaded', initApp);

    function initApp() {
      initMap();
      setupBaseSwitcher();
      setupFilters();
      setupSearch();
      loadGeoJSON();
      runIntroAnimations();
    }

    function initMap() {
      map = L.map('map', {
        zoomControl: false
      });

      var baseClaro = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      });

      var baseSat = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        {
          maxZoom: 19,
          attribution:
            'Tiles © Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }
      );

      var baseTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution:
          'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
      });

      baseLayers = {
        claro: baseClaro,
        satellite: baseSat,
        topo: baseTopo
      };

      baseLayer = baseClaro.addTo(map);

      L.control.zoom({ position: 'bottomright' }).addTo(map);

      map.setView([23.6345, -102.5528], 5);
    }

    function setupBaseSwitcher() {
      var buttons = document.querySelectorAll('.map-base-btn');
      if (!buttons.length) return;

      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var key = btn.getAttribute('data-base');
          if (!key || key === currentBaseKey || !baseLayers[key]) return;

          if (baseLayer) {
            map.removeLayer(baseLayer);
          }
          baseLayer = baseLayers[key];
          baseLayer.addTo(map);
          currentBaseKey = key;

          buttons.forEach(function (b) {
            b.classList.remove('is-active');
          });
          btn.classList.add('is-active');
        });
      });
    }

    function loadGeoJSON() {
      fetch('Prueba_1.geojson')
        .then(function (response) {
          if (!response.ok) {
            throw new Error('No se pudo cargar Prueba_1.geojson');
          }
          return response.json();
        })
        .then(function (data) {
          geojsonData = data;
          populateSelectorsFromData();
          renderLots('all');
          setupSelectors();
        })
        .catch(function (error) {
          console.error(error);
          var alertBox = document.getElementById('geojson-error');
          if (alertBox) {
            alertBox.textContent =
              'No se pudo cargar el archivo de lotes. Verifica que "Prueba_1.geojson" esté en la misma carpeta que este archivo HTML o ajusta la ruta en el código.';
            alertBox.style.display = 'block';
          }
        });
    }

    function populateSelectorsFromData() {
      if (!geojsonData || !Array.isArray(geojsonData.features)) return;

      var devSet = {};
      var secSet = {};

      geojsonData.features.forEach(function (feature) {
        var p = feature.properties || {};
        var dev = p['04-04Desar'];
        var sec = p['04-04Secci'];
        if (dev && dev.toString().trim()) devSet[dev] = true;
        if (sec && sec.toString().trim()) secSet[sec] = true;
      });

      var devValues = Object.keys(devSet).sort();
      var secValues = Object.keys(secSet).sort();

      var devSelect = document.getElementById('dev-select');
      var secSelect = document.getElementById('sec-select');

      if (devSelect) {
        devSelect.innerHTML = '<option value="all">Todos los desarrollos</option>';
        devValues.forEach(function (v) {
          var opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          devSelect.appendChild(opt);
        });
      }

      if (secSelect) {
        secSelect.innerHTML = '<option value="all">Todas las secciones</option>';
        secValues.forEach(function (v) {
          var opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          secSelect.appendChild(opt);
        });
      }
    }

    function setupSelectors() {
      var devSelect = document.getElementById('dev-select');
      var secSelect = document.getElementById('sec-select');

      if (devSelect) {
        devSelect.addEventListener('change', function () {
          currentDesarrollo = devSelect.value || 'all';
          renderLots(currentFilter);
        });
      }

      if (secSelect) {
        secSelect.addEventListener('change', function () {
          currentSeccion = secSelect.value || 'all';
          renderLots(currentFilter);
        });
      }
    }

    function getFilterFn(filterName) {
      if (!filterName || filterName === 'all') {
        return function () {
          return true;
        };
      }

      if (filterName === 'available') {
        return function (feature) {
          var p = feature.properties || {};
          return p['04-04Dispo'] === 'Disponible';
        };
      }

      if (filterName === 'process') {
        return function (feature) {
          var p = feature.properties || {};
          var d = p['04-04Dispo'];
          return d === 'En Proceso de Alta' || d === 'V. En Proceso';
        };
      }

      if (filterName === 'nodisp') {
        return function (feature) {
          var p = feature.properties || {};
          var d = p['04-04Dispo'];
          if (!d) return false;
          return d !== 'Disponible' && d !== 'En Proceso de Alta' && d !== 'V. En Proceso';
        };
      }

      return function () {
        return true;
      };
    }

    function getFillColor(dispo) {
      if (dispo === 'Disponible') return COLORS.fonaturTeal;
      if (dispo === 'En Proceso de Alta' || dispo === 'V. En Proceso') return COLORS.fonaturGold;
      if (dispo === 'No disponible') return COLORS.grey;
      return COLORS.fonaturGreen;
    }

    function styleByFeature(feature) {
      var p = feature.properties || {};
      var dispo = p['04-04Dispo'];
      return {
        color: '#ffffff',
        weight: 1,
        opacity: 0.9,
        fillColor: getFillColor(dispo),
        fillOpacity: 0.82
      };
    }

    function highlightFeature(event, layer) {
      var target = layer || event.target;
      target.setStyle({
        weight: 3,
        color: COLORS.fonaturGold,
        fillOpacity: 0.95
      });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        target.bringToFront();
      }
    }

    function resetHighlight(event) {
      if (!lotLayer) return;
      lotLayer.resetStyle(event.target);
    }

    function makeLotItem(feature, layer) {
      var props = feature.properties || {};
      var desar = props['04-04Desar'] || '';
      var secci = props['04-04Secci'] || '';
      var manza = props['04-04Manza'] || '';
      var loteId = props['04-04Lote'] || '';
      var dispo = props['04-04Dispo'] || '';
      var uso = props['04-04Descr'] || props['Uso_suelo'] || props['uso_suelo'] || '';
      var sup = props['04-04Super'] || '';
      var precio = props['04-04Preci'] || '';
      var nombreAttr = props.Nombre || '';

      var loteName = loteId ? 'Lote ' + loteId : nombreAttr || 'Lote sin nombre';

      var popupHtml =
        '<div class="popup-lot">' +
        '<h3>' + escapeHtml(loteName) + '</h3>' +
        '<p class="popup-location"><strong>Desarrollo:</strong> ' + escapeHtml(desar) + '</p>' +
        (secci ? '<p><strong>Sección:</strong> ' + escapeHtml(secci) + '</p>' : '') +
        (manza ? '<p><strong>Manzana:</strong> ' + escapeHtml(manza) + '</p>' : '') +
        (uso ? '<p><strong>Uso de suelo:</strong> ' + escapeHtml(uso) + '</p>' : '') +
        (sup ? '<p><strong>Superficie:</strong> ' + escapeHtml(sup) + ' m²</p>' : '') +
        (precio ? '<p><strong>Precio referencia:</strong> ' + escapeHtml(precio) + '</p>' : '') +
        (dispo ? '<p><strong>Estatus:</strong> ' + escapeHtml(dispo) + '</p>' : '') +
        '</div>';

      layer.bindPopup(popupHtml);

      layer.on({
        mouseover: function (e) {
          highlightFeature(e, layer);
        },
        mouseout: function (e) {
          resetHighlight(e);
        },
        click: function () {
          map.fitBounds(layer.getBounds(), { maxZoom: 18 });
          layer.openPopup();
        }
      });

      return {
        layer: layer,
        feature: feature,
        props: props
      };
    }

    function renderLots(filterName) {
      if (!geojsonData) return;

      currentFilter = filterName || currentFilter || 'all';

      if (lotLayer) {
        lotLayer.remove();
        lotLayer = null;
      }

      lotItems = [];

      var dispoFilter = getFilterFn(currentFilter);

      lotLayer = L.geoJSON(geojsonData, {
        style: styleByFeature,
        filter: function (feature) {
          if (!dispoFilter(feature)) return false;
          var p = feature.properties || {};

          if (currentDesarrollo !== 'all' && p['04-04Desar'] !== currentDesarrollo) {
            return false;
          }

          if (currentSeccion !== 'all' && p['04-04Secci'] !== currentSeccion) {
            return false;
          }

          return true;
        },
        onEachFeature: function (feature, layer) {
          var item = makeLotItem(feature, layer);
          lotItems.push(item);
        }
      }).addTo(map);

      if (lotLayer.getLayers().length > 0) {
        map.fitBounds(lotLayer.getBounds(), { padding: [12, 12] });
      }

      updateStatsFromItems(lotItems);
      buildLotList(lotItems);
    }

    function updateStatsFromItems(items) {
      var totalLots = items.length;
      var available = 0;
      var process = 0;
      var totalArea = 0;

      items.forEach(function (item) {
        var p = item.props || {};
        var d = p['04-04Dispo'];

        if (d === 'Disponible') available++;
        else if (d === 'En Proceso de Alta' || d === 'V. En Proceso') process++;

        var supStr = p['04-04Super'];
        var area = parseSurface(supStr);
        if (!isNaN(area)) {
          totalArea += area;
        }
      });

      var totalEl = document.getElementById('stat-total');
      var availEl = document.getElementById('stat-available');
      var processEl = document.getElementById('stat-process');
      var areaEl = document.getElementById('stat-area');
      var heroAreaEl = document.getElementById('hero-area');
      var listCountEl = document.getElementById('lot-list-count');

      if (totalEl) totalEl.textContent = totalLots.toLocaleString('es-MX');
      if (availEl) availEl.textContent = available.toLocaleString('es-MX');
      if (processEl) processEl.textContent = process.toLocaleString('es-MX');
      if (areaEl)
        areaEl.textContent =
          totalLots > 0 ? totalArea.toLocaleString('es-MX', { maximumFractionDigits: 0 }) + ' m²' : '—';
      if (heroAreaEl)
        heroAreaEl.textContent =
          totalLots > 0 ? totalArea.toLocaleString('es-MX', { maximumFractionDigits: 0 }) + ' m²' : '—';
      if (listCountEl)
        listCountEl.textContent =
          totalLots > 0
            ? totalLots.toLocaleString('es-MX') + ' lotes en el filtro actual'
            : 'Sin lotes para el filtro actual';
    }

    function buildLotList(items) {
      var container = document.getElementById('lot-list');
      if (!container) return;

      container.innerHTML = '';

      if (!items || items.length === 0) {
        container.innerHTML = '<p class="empty-message">No hay lotes que coincidan con el filtro actual.</p>';
        return;
      }

      var maxItems = 80;

      items.slice(0, maxItems).forEach(function (item) {
        var props = item.props || {};
        var loteId = props['04-04Lote'] || '';
        var manza = props['04-04Manza'] || '';
        var secci = props['04-04Secci'] || '';
        var desar = props['04-04Desar'] || '';
        var dispo = props['04-04Dispo'] || '';
        var sup = props['04-04Super'] || '';
        var precio = props['04-04Preci'] || '';

        var card = document.createElement('button');
        card.type = 'button';
        card.className = 'lot-card';

        var dispoLabel = dispo || 'Sin estatus';

        card.innerHTML =
          '<div class="lot-card-header">' +
          '<span class="lot-badge">' + escapeHtml(dispoLabel) + '</span>' +
          '</div>' +
          '<div>' +
          '<h4 class="lot-name">' +
          escapeHtml(loteId ? 'Lote ' + loteId + (manza ? ' · Mza ' + manza : '') : 'Lote') +
          '</h4>' +
          '<p class="lot-location">' +
          escapeHtml(secci || '') +
          (desar ? ' · ' + escapeHtml(desar) : '') +
          '</p>' +
          '</div>' +
          '<div class="lot-card-meta">' +
          (sup ? '<span>' + escapeHtml(sup) + ' m²</span>' : '') +
          (precio ? '<span>' + escapeHtml(precio) + '</span>' : '') +
          '</div>';

        card.addEventListener('click', function () {
          var layer = item.layer;
          if (layer) {
            map.fitBounds(layer.getBounds(), { maxZoom: 18 });
            layer.openPopup();

            if (window.anime) {
              anime({
                targets: card,
                scale: [1, 1.02, 1],
                duration: 450,
                easing: 'easeOutQuad'
              });
            }
          }
        });

        container.appendChild(card);
      });

      if (window.anime) {
        anime({
          targets: '.lot-card',
          opacity: [0, 1],
          translateY: [8, 0],
          delay: anime.stagger(20),
          duration: 420,
          easing: 'easeOutQuad'
        });
      }
    }

    function setupFilters() {
      var chips = document.querySelectorAll('.filter-chip');
      if (!chips.length) return;

      chips.forEach(function (chip) {
        chip.addEventListener('click', function () {
          var filter = chip.getAttribute('data-filter');
          chips.forEach(function (c) {
            c.classList.remove('is-active');
          });
          chip.classList.add('is-active');
          renderLots(filter);
        });
      });
    }

    function setupSearch() {
      var input = document.getElementById('search-input');
      if (!input) return;

      input.addEventListener('input', function () {
        var term = input.value.toLowerCase().trim();
        if (!term) {
          buildLotList(lotItems);
          return;
        }

        var filtered = lotItems.filter(function (item) {
          var p = item.props || {};
          var text = [
            p['04-04Lote'],
            p['04-04Manza'],
            p['04-04Secci'],
            p['04-04Desar'],
            p['04-04Descr'],
            p['Uso_suelo'],
            p['uso_suelo'],
            p['04-04Dispo'],
            p.Nombre
          ]
            .join(' ')
            .toLowerCase();
          return text.indexOf(term) !== -1;
        });

        buildLotList(filtered);
      });
    }

    function runIntroAnimations() {
      if (!window.anime) return;

      anime({
        targets: '.top-nav',
        translateY: [-16, 0],
        opacity: [0, 1],
        duration: 720,
        easing: 'easeOutExpo'
      });

      anime({
        targets: '.hero-badge',
        translateY: [-10, 0],
        opacity: [0, 1],
        delay: 220,
        duration: 600,
        easing: 'easeOutExpo'
      });

      anime({
        targets: '.hero-title',
        translateY: [30, 0],
        opacity: [0, 1],
        delay: 320,
        duration: 750,
        easing: 'easeOutExpo'
      });

      anime({
        targets: '.hero-subtitle',
        translateY: [20, 0],
        opacity: [0, 1],
        delay: 420,
        duration: 700,
        easing: 'easeOutExpo'
      });

      anime({
        targets: '.hero-actions .btn',
        translateY: [15, 0],
        opacity: [0, 1],
        delay: anime.stagger(80, { start: 520 }),
        duration: 550,
        easing: 'easeOutQuad'
      });

      anime({
        targets: '.stat-card',
        translateY: [12, 0],
        opacity: [0, 1],
        delay: anime.stagger(80, { start: 700 }),
        duration: 550,
        easing: 'easeOutQuad'
      });
    }
  })();
</script>
